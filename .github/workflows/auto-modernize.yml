# GitHub Actions workflow for automatic Go code modernization
# Runs golangci-lint with --fix flag to apply automatic modernizations
# and creates a PR with the changes

name: Auto Modernize

on:
  # Run weekly on Monday at 9:00 AM UTC
  schedule:
    - cron: '0 9 * * 1'

  # Allow manual trigger
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  modernize:
    name: Modernize Go Code
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # Use a PAT or GitHub App token to allow PR creation to trigger other workflows
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.25.x"
          cache: true

      - name: Install golangci-lint
        run: |
          go install github.com/golangci/golangci-lint/v2/cmd/golangci-lint@latest

      - name: Run golangci-lint with auto-fix
        id: lint-fix
        run: |
          # Run with --fix to apply automatic fixes
          golangci-lint run --fix --timeout=10m || true

          # Check if there are any changes
          if [[ -n $(git status --porcelain) ]]; then
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "âœ… Changes detected after modernization"
          else
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No changes needed - code is already modern!"
          fi

      - name: Run go mod tidy
        if: steps.lint-fix.outputs.changes == 'true'
        run: go mod tidy

      - name: Create Pull Request
        if: steps.lint-fix.outputs.changes == 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: modernize Go code with golangci-lint auto-fixes"
          title: "ðŸ¤– Automated Go Code Modernization"
          body: |
            ## ðŸš€ Automated Go Code Modernization

            This PR contains automatic code modernizations applied by `golangci-lint --fix`.

            ### Changes Applied

            The following linters were used to modernize the code:
            - **modernize**: Simplifications using modern Go constructs
            - **staticcheck**: Modern best practices
            - **gocritic**: Code improvements
            - **errorlint**: Modern error handling
            - **unconvert**: Removed unnecessary type conversions
            - And other enabled linters with auto-fix capability

            ### What to Review

            - âœ… All tests should pass
            - âœ… Code should be more idiomatic and maintainable
            - âœ… Modern Go features are properly utilized
            - âš ï¸ Review any behavioral changes carefully

            ### Auto-generated by

            This PR was automatically created by the [Auto Modernize workflow](.github/workflows/auto-modernize.yml).

            ---

            _If you don't want these automatic modernization PRs, you can:_
            - _Disable the workflow_
            - _Adjust the schedule in `.github/workflows/auto-modernize.yml`_
            - _Add specific linters to exclusions in `.golangci.yml`_
          branch: auto-modernize/golangci-lint-fixes
          delete-branch: true
          labels: |
            automated
            refactor
            modernization
          assignees: ${{ github.repository_owner }}
          draft: false

      - name: Summary
        if: steps.lint-fix.outputs.changes == 'true'
        run: |
          echo "### âœ… Modernization PR Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "A pull request has been created with automatic Go code modernizations." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check the [Pull Requests](${{ github.server_url }}/${{ github.repository }}/pulls) tab to review the changes." >> $GITHUB_STEP_SUMMARY

      - name: Summary (No Changes)
        if: steps.lint-fix.outputs.changes == 'false'
        run: |
          echo "### â„¹ï¸ No Changes Needed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Your code is already following modern Go best practices! ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
